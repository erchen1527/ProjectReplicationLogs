<!--
 * @FilePath: 1.1.replication_process.md
 * @Author: erchen
 * @Date: 2024-08-15 17:20:51
 * @LastEditTime: 2024-08-16 16:22:37
 * @Descripttion: 
-->

- [1.下载项目代码](#1下载项目代码)
- [2.环境搭建](#2环境搭建)
  - [2.1.配置虚拟环境](#21配置虚拟环境)
  - [2.2.安装pytorch](#22安装pytorch)
  - [2.3.安装其他必要包](#23安装其他必要包)
- [3.勘误与优化](#3勘误与优化)
  - [3.1.勘误](#31勘误)
  - [3.2.优化](#32优化)
- [4.启动训练](#4启动训练)
- [5.其他](#5其他)

# 1.下载项目代码

使用命令`git clone`下载项目代码：

```bash
$ git clone git@github.com:omegafragger/DDU.git
Cloning into 'DDU'...
remote: Enumerating objects: 146, done.
remote: Counting objects: 100% (13/13), done.
remote: Compressing objects: 100% (11/11), done.
remote: Total 146 (delta 4), reused 2 (delta 2), pack-reused 133 (from 1)
Receiving objects: 100% (146/146), 26.75 MiB | 2.40 MiB/s, done.
Resolving deltas: 100% (30/30), done.
```

进入项目目录：

```bash
$ cd DDU
$ ls
LICENSE  README.md  active_learning_script.py  data  environment.yml  evaluate.py  metrics  net  notebooks  train.py  train_ensemble.py  utils  vis
```

# 2.环境搭建

## 2.1.配置虚拟环境

创建并激活虚拟环境：

```bash
$ conda create -n DDU python=3.9
$ conda activate DDU
```

如果想要退出虚拟环境，使用命令：

```bash
$ conda deactivate
```

## 2.2.安装pytorch

安装pytorch，当前版本为：

* torch-2.4.0-cu118
* torchvision-0.19.0-cu118

其他满足要求的版本亦可：

```bash
$ pip3 install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

也可以先下载对应的whl包:

[torch下载地址](https://download.pytorch.org/whl/cu118/torch-2.4.0%2Bcu118-cp39-cp39-linux_x86_64.whl)

[torchvision下载地址](https://download.pytorch.org/whl/cu118/torchvision-0.19.0%2Bcu118-cp39-cp39-linux_x86_64.whl)

然后在本地安装，

```bash
$ pip install torch-2.4.0+cu118-cp39-cp39-linux_x86_64.whl
$ pip install torchvision-0.19.0+cu118-cp39-cp39-linux_x86_64.whl
```

## 2.3.安装其他必要包

安装其他必要的包：

```bash
$ pip install scikit-learn matplotlib tensorboard
```

# 3.勘误与优化

## 3.1.勘误

**（1）File "train_ensemble.py", line 88**

数据加载字典，在使用时名字错误，多加了一个'_'：

```python
train_loader, _ = data_set_loader[args.dataset].get_train_valid_loader(
```

-->

```python
train_loader, _ = dataset_loader[args.dataset].get_train_valid_loader(
```

## 3.2.优化

**（2）File "data/ood_detection/cifar10.py", line 53**

数据集存放与数据处理的代码在同一个目录，较为混乱，修改数据集存放的目录：

```python
data_dir = "./data"
```

-->

```python
data_dir = "./dataset"
```

# 4.启动训练

**（1）启动用于训练深度集成模型的脚本**

随机种子没有给定默认值，所以需要自己指定一个值：

```bash
$ python train_ensemble.py --seed 404
Parsed args Namespace(seed=404, dataset='cifar10', dataset_root='./', data_aug=True, train_batch_size=128, test_batch_size=128, gpu=True, model='resnet50', sn=False, coeff=3.0, mod=False, epoch=350, learning_rate=0.1, momentum=0.9, nesterov=False, weight_decay=0.0005, optimiser='sgd', loss_function='cross_entropy', loss_mean=False, log_interval=50, save_interval=25, saved_model_name='resnet50_350.model', save_loc='./', first_milestone=150, second_milestone=250, ensemble=5)
Seed:  404
CUDA set: True
Files already downloaded and verified
Files already downloaded and verified
Files already downloaded and verified
Files already downloaded and verified
Files already downloaded and verified
Ensemble Model: 0
Train Epoch: 0 [0/45056 (0%)]   Loss: 2.483441
Train Epoch: 0 [1280/45056 (3%)]        Loss: 7.542034
Train Epoch: 0 [2560/45056 (6%)]        Loss: 3.186158
```

**（2）启动用于训练OOD检测的单个模型的脚本**

随机种子同上：

```bash
$ python train.py --seed 404
Parsed args Namespace(seed=404, dataset='cifar10', dataset_root='./', data_aug=True, train_batch_size=128, test_batch_size=128, gpu=True, model='resnet50', sn=False, coeff=3.0, mod=False, epoch=350, learning_rate=0.1, momentum=0.9, nesterov=False, weight_decay=0.0005, optimiser='sgd', loss_function='cross_entropy', loss_mean=False, log_interval=50, save_interval=25, saved_model_name='resnet50_350.model', save_loc='./', first_milestone=150, second_milestone=250)
Seed:  404
CUDA set: True
Files already downloaded and verified
Model save name resnet50_404
Starting epoch 0
Train Epoch: 0 [0/45056 (0%)]   Loss: 2.571999
Train Epoch: 0 [1280/45056 (3%)]        Loss: 13.522068
Train Epoch: 0 [2560/45056 (6%)]        Loss: 2.632864
```

# 5.其他

**（1）去除 `Zone.Identifier` 文件**

使用 wsl 时，从外部复制文件时，可能存在同名的后缀为 `Zone.Identifier` 的文件，是一些附加信息，可以用以下命令删除：

```bash
$ find . -name "*:Zone.Identifier" -type f -delete
```

**（2）创建 `.gitignore` 文件**

vscode运行python脚本的时候会出现很多 `__pycache__` 文件夹，内含 .pyc 文件，上传 git 时这些文件没必要传上去，可以在 `gitignore` 中加入规则忽略。同时也可以把数据集、输出目录添加进去。

在终端中输入以下命令,使用 `vim` 编辑器创建 `.gitignore` 文件：

```bash
$ vim .gitignore
```

vim 打开时，默认处于命令模式。按下 i 键即可进入插入模式，开始编辑文件：

```
__pycache__/
dataset/
stats_logging/
```

完成编辑后，按下 Esc 键退出插入模式，回到命令模式。输入 :wq 保存更改并退出 vim。按下 Enter 键执行保存并退出的命令。

**（3）提交本地仓库**

使用 `git status` 命令可以看到工作目录做出的更改：

```bash
$ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   data/ood_detection/cifar10.py
        modified:   train_ensemble.py

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        .gitignore

no changes added to commit (use "git add" and/or "git commit -a")
```

使用 `git add` 将这些文件添加到暂存区，可以依次添加，也可以使用 `git add .` 添加所有更改的文件：

```bash
$ git add .

$ git add data/ood_detection/cifar10.py
$ git add train_ensemble.py
$ git add .gitignore
```

然后提交到本地仓库：

```bash
$ git commit -m 'complete replication'
```

可以使用 'git log' 查看提交记录：

```bash
$ git log
commit bc897b66e2f157ae50ca244cbf8e9b8f3d4bb48a (HEAD -> main)
Author: user.name <user.email>
Date:   Fri Aug 16 15:18:19 2024 +0800

    complete replication
```

后续进行更改后，想回到此版本，可以根据 commit id 回退，一般输入前7位即可：

```bash
$ git reset --hard bc897b6
```

同时 `git reflog` 用来记录你的每一次命令，防止回退到旧版本后，找不到新版本的 commit id。